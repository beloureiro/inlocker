<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scheduled Backup - InLocker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #030712;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .logo-img {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    .logo-text h1 { font-size: 20px; font-weight: 600; color: white; }
    .logo-text .subtitle { font-size: 12px; color: #9ca3af; }
    .backup-name {
      font-size: 18px;
      font-weight: 700;
      color: #10b981;
    }
    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 16px;
      width: 100%;
      max-width: 400px;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #065f46;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    .stage {
      text-align: center;
      margin-bottom: 12px;
    }
    .stage-name {
      font-size: 12px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .stage-message { color: #e5e7eb; }
    .stage-details {
      font-size: 12px;
      color: #6b7280;
      font-family: monospace;
      margin-top: 4px;
    }
    .progress-bar {
      margin-bottom: 8px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .progress-track {
      width: 100%;
      height: 8px;
      background: #1f2937;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #059669;
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .file-counter {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      font-family: monospace;
    }
    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #1f2937;
    }
    .stat-item {
      text-align: center;
      flex: 1;
    }
    .stat-value {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      font-family: monospace;
    }
    .stat-value.pending {
      color: #4b5563;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .stat-label {
      font-size: 10px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 2px;
    }
    .footer {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      margin-top: 16px;
    }
    .completed .spinner { display: none; }
    .completed .stage-name { color: #10b981; }
    .error .spinner { display: none; }
    .error .stage-name { color: #ef4444; }
    .error .progress-fill { background: #ef4444; }
  </style>
</head>
<body>
  <div class="logo">
    <img src="/logo.png" alt="InLocker Logo" class="logo-img">
    <div class="logo-text">
      <h1>InLocker</h1>
      <p class="subtitle">Scheduled Backup</p>
      <p class="backup-name" id="backup-name"></p>
    </div>
  </div>

  <div class="card" id="progress-card">
    <div class="spinner" id="spinner"></div>
    <div class="stage">
      <p class="stage-name" id="stage-name">initializing</p>
      <p class="stage-message" id="stage-message">Starting scheduled backup...</p>
      <p class="stage-details" id="stage-details"></p>
    </div>
    <div class="progress-bar">
      <div class="progress-header">
        <span>Progress</span>
        <span id="percentage">0%</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
    <div class="file-counter" id="file-counter"></div>
    <div class="stats-row" id="stats-row" style="display: none;">
      <div class="stat-item">
        <div class="stat-value" id="elapsed-time">00:00</div>
        <div class="stat-label">Elapsed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="original-size">--</div>
        <div class="stat-label">Original</div>
      </div>
      <div class="stat-item">
        <div class="stat-value pending" id="compressed-size">...</div>
        <div class="stat-label">Compressed</div>
      </div>
    </div>
  </div>

  <p class="footer" id="footer">Window will close automatically when complete</p>

  <script type="module">
    // Import Tauri APIs from CDN (required for static HTML in public/)
    const { listen } = await import('https://unpkg.com/@tauri-apps/api@2/event');
    const { getCurrentWindow } = await import('https://unpkg.com/@tauri-apps/api@2/window');
    const { invoke } = await import('https://unpkg.com/@tauri-apps/api@2/core');

    console.log('[progress.html] Script loaded');

    // DOM elements
    const backupName = document.getElementById('backup-name');
    const stageName = document.getElementById('stage-name');
    const stageMessage = document.getElementById('stage-message');
    const stageDetails = document.getElementById('stage-details');
    const percentage = document.getElementById('percentage');
    const progressFill = document.getElementById('progress-fill');
    const fileCounter = document.getElementById('file-counter');
    const progressCard = document.getElementById('progress-card');
    const spinner = document.getElementById('spinner');
    const footer = document.getElementById('footer');
    const statsRow = document.getElementById('stats-row');
    const elapsedTimeEl = document.getElementById('elapsed-time');
    const originalSizeEl = document.getElementById('original-size');
    const compressedSizeEl = document.getElementById('compressed-size');

    // Preferences (loaded from backend)
    let autoCloseEnabled = true;
    let autoCloseDelay = 3000;

    // Load preferences from backend
    try {
      const prefs = await invoke('load_preferences');
      autoCloseEnabled = prefs.auto_close_progress_window;
      autoCloseDelay = prefs.auto_close_delay_ms;
      console.log('[progress.html] Loaded preferences:', { autoCloseEnabled, autoCloseDelay });

      // Update footer text based on preference
      if (!autoCloseEnabled) {
        footer.textContent = 'Close this window manually when done';
      }
    } catch (err) {
      console.warn('[progress.html] Failed to load preferences, using defaults:', err);
    }

    // Timer state
    let startTime = null;
    let timerInterval = null;

    // Format seconds to MM:SS or HH:MM:SS
    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      if (hrs > 0) {
        return `${hrs}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Format bytes to human readable
    function formatSize(bytes) {
      if (bytes === 0) return '--';
      const gb = bytes / (1024 * 1024 * 1024);
      if (gb >= 1) return `${gb.toFixed(1)} GB`;
      const mb = bytes / (1024 * 1024);
      return `${mb.toFixed(0)} MB`;
    }

    // Start elapsed time timer
    function startTimer() {
      if (timerInterval) return;
      startTime = Date.now();
      statsRow.style.display = 'flex';
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        elapsedTimeEl.textContent = formatTime(elapsed);
      }, 1000);
    }

    // Stop timer
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // Listen for backup progress
    await listen('backup:progress', (event) => {
      console.log('[progress.html] Progress event:', event.payload);
      const data = event.payload;

      // Start timer on first progress event (not initializing)
      if (data.stage && data.stage !== 'initializing' && !startTime) {
        startTimer();
      }

      stageName.textContent = data.stage || 'processing';
      stageMessage.textContent = data.message || '';
      stageDetails.textContent = data.details || '';

      // Calculate percentage
      let pct = 0;
      if (data.current !== undefined && data.total !== undefined && data.total > 0) {
        pct = Math.round((data.current / data.total) * 100);
      }
      percentage.textContent = pct + '%';
      progressFill.style.width = pct + '%';

      // File counter
      if (data.current !== undefined && data.total !== undefined) {
        fileCounter.textContent = data.current.toLocaleString() + ' / ' + data.total.toLocaleString() + ' files';
      }

      // Update sizes if available
      if (data.original_size !== undefined && data.original_size > 0) {
        originalSizeEl.textContent = formatSize(data.original_size);
      }
      if (data.compressed_size !== undefined && data.compressed_size > 0) {
        compressedSizeEl.textContent = formatSize(data.compressed_size);
        compressedSizeEl.classList.remove('pending');
      }

      // Completed state - auto close after delay (if enabled)
      if (data.stage === 'completed') {
        console.log('[progress.html] COMPLETED EVENT RECEIVED!', data);
        stopTimer();
        progressCard.classList.add('completed');
        spinner.style.display = 'none';

        if (autoCloseEnabled) {
          footer.textContent = `Closing in ${autoCloseDelay / 1000} seconds...`;

          setTimeout(async () => {
            try {
              const window = getCurrentWindow();
              await window.close();
            } catch (err) {
              console.error('[progress.html] Failed to close window:', err);
            }
          }, autoCloseDelay);
        } else {
          footer.textContent = 'Backup complete! Close this window manually';
        }
      }

      // Error state
      if (data.stage === 'error') {
        stopTimer();
        progressCard.classList.add('error');
        spinner.style.display = 'none';
        footer.textContent = 'Close this window manually';
      }
    });

    // Listen for test backup trigger (from Test Now button)
    await listen('test-backup-trigger', async (event) => {
      console.log('[progress.html] Test backup trigger:', event.payload);
      const { config_id: configId, config_name: configName } = event.payload;

      // Update backup name display
      backupName.textContent = configName || 'Scheduled Backup';
      stageMessage.textContent = 'Test backup starting...';

      try {
        await invoke('run_backup_now', { configId, password: undefined });
        console.log('[progress.html] Backup invoke completed');
      } catch (err) {
        console.error('[progress.html] Backup failed:', err);
        stageName.textContent = 'error';
        stageMessage.textContent = 'Backup failed';
        stageDetails.textContent = String(err);
        progressCard.classList.add('error');
        spinner.style.display = 'none';
        footer.textContent = 'Close this window manually';
      }
    });

    // Emit window-ready to notify Rust that the window is loaded
    const window = getCurrentWindow();
    await window.emit('window-ready', { label: window.label });
    console.log('[progress.html] Emitted window-ready for:', window.label);
  </script>
</body>
</html>
